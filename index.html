<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Latency test</title>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/uplot@1.6.13/dist/uPlot.iife.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/uplot@1.6.13/dist/uPlot.min.css">

</head>

<body>
  <h1>Latency test</h1>

  <p><strong>WS latency:</strong> <span id="ws">--</span> ms (<span id="ws-rolling">--</span> ms rolling)</p>
  <p><strong>HTTP latency:</strong> <span id="http">--</span> ms (<span id="http-rolling">--</span> ms rolling)</p>
  <p><strong>Time diff:</strong> <span id="time">--</span> ms (<span id="time-rolling">--</span> ms rolling)</p>

  <div id="plot"></div>

  <script async>
    const socket = io();
    const plot = new uPlot({
      width: 800,
      height: 600,
      axes: [{}, { scale: "ms" }],
      series: [{}, { label: "WebSocket", stroke: "blue", scale: "ms" }, { scale: "time diff", stroke: "green", scale: "ms" }, { scale: "HTTP", stroke: "red", scale: "ms" }],
    }, [], document.getElementById("plot"));

    const plotData = [[], [], [], []];

    const ws = document.getElementById("ws");
    const wsRolling = document.getElementById("ws-rolling");

    const http = document.getElementById("http");
    const httpRolling = document.getElementById("http-rolling");

    const time = document.getElementById("time");
    const timeRolling = document.getElementById("time-rolling");

    const wsLatencies = [];
    const addWsLatency = (latency) => {
      ws.innerText = latency.toFixed(1);
      wsLatencies.push(latency);

      const rolling = wsLatencies.slice(wsLatencies.length - 10).reduce((acc, cur) => acc + cur, 0) / Math.min(wsLatencies.length, 10);
      wsRolling.innerText = rolling.toFixed(1);
    }

    const httpLatencies = [];
    const addHttpLatency = (latency) => {
      http.innerText = latency.toFixed(1);
      httpLatencies.push(latency);

      const rolling = httpLatencies.slice(httpLatencies.length - 10).reduce((acc, cur) => acc + cur, 0) / Math.min(httpLatencies.length, 10);
      httpRolling.innerText = rolling.toFixed(1);
    }

    const timeDiffs = [];
    const addTime = (timeDiff) => {
      time.innerText = timeDiff.toFixed(1);
      timeDiffs.push(timeDiff);

      if (timeDiffs.length > 10) {
        timeDiffs.unshift();
      }

      const rolling = timeDiffs.slice(wsLatencies.length - 10).reduce((acc, cur) => acc + cur, 0) / Math.min(timeDiffs.length, 10);
      timeRolling.innerText = rolling.toFixed(1);
    }

    setInterval(async () => {
      const start = Date.now();
      const [[latency, timeDiff], http] = await Promise.all([
        new Promise(res => {
          socket.volatile.emit("time", start, (timeDiff) => {
            res([Date.now() - start, timeDiff]);
          });
        }),
        fetch("/test").then(r => Date.now() - start)
      ]);

      addTime(timeDiff);
      addWsLatency(latency);
      addHttpLatency(http);

      plotData[0].push(start / 1000);
      plotData[1].push(latency);
      plotData[2].push(timeDiff);
      plotData[3].push(http);
      plot.setData(plotData);
    }, 250);
  </script>
</body>

</html>